<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Packware-cvs] pwbuild/xap/psi indicator.png,NONE,1.1 psi-cvs.pwbuild,NONE,1.1 psi-enable-mng.pw.patch,NONE,1.1 psi-no_default_status_text.patch,NONE,1.1 psi-no_online_status.patch,NONE,1.1 psi-offline_status.patch,NONE,1.1 psi-opt.pw.patch,NONE,1.1 psi-status_history.patch,NONE,1.1 psi-status_indicator-cvs.patch,NONE,1.1 psi-status_indicator.patch,NONE,1.1 psi-translations.pw.patch,NONE,1.1 psi.pwbuild,NONE,1.1 psi.pwinfo,NONE,1.1 uic-wrapper,NONE,1.1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/packware-cvs/2004-July/index.html" >
   <LINK REL="made" HREF="mailto:packware-cvs%40lists.berlios.de?Subject=Re%3A%20%5BPackware-cvs%5D%20pwbuild/xap/psi%20indicator.png%2CNONE%2C1.1%20psi-cvs.pwbuild%2CNONE%2C1.1%20psi-enable-mng.pw.patch%2CNONE%2C1.1%20psi-no_default_status_text.patch%2CNONE%2C1.1%20psi-no_online_status.patch%2CNONE%2C1.1%20psi-offline_status.patch%2CNONE%2C1.1%20psi-opt.pw.patch%2CNONE%2C1.1%20psi-status_history.patch%2CNONE%2C1.1%20psi-status_indicator-cvs.patch%2CNONE%2C1.1%20psi-status_indicator.patch%2CNONE%2C1.1%20psi-translations.pw.patch%2CNONE%2C1.1%20psi.pwbuild%2CNONE%2C1.1%20psi.pwinfo%2CNONE%2C1.1%20uic-wrapper%2CNONE%2C1.1&In-Reply-To=%3C200407302034.i6UKYu622486%40bat.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000049.html">
   <LINK REL="Next"  HREF="000051.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Packware-cvs] pwbuild/xap/psi indicator.png,NONE,1.1 psi-cvs.pwbuild,NONE,1.1 psi-enable-mng.pw.patch,NONE,1.1 psi-no_default_status_text.patch,NONE,1.1 psi-no_online_status.patch,NONE,1.1 psi-offline_status.patch,NONE,1.1 psi-opt.pw.patch,NONE,1.1 psi-status_history.patch,NONE,1.1 psi-status_indicator-cvs.patch,NONE,1.1 psi-status_indicator.patch,NONE,1.1 psi-translations.pw.patch,NONE,1.1 psi.pwbuild,NONE,1.1 psi.pwinfo,NONE,1.1 uic-wrapper,NONE,1.1</H1>
    <B>swiergot</B> 
    <A HREF="mailto:packware-cvs%40lists.berlios.de?Subject=Re%3A%20%5BPackware-cvs%5D%20pwbuild/xap/psi%20indicator.png%2CNONE%2C1.1%20psi-cvs.pwbuild%2CNONE%2C1.1%20psi-enable-mng.pw.patch%2CNONE%2C1.1%20psi-no_default_status_text.patch%2CNONE%2C1.1%20psi-no_online_status.patch%2CNONE%2C1.1%20psi-offline_status.patch%2CNONE%2C1.1%20psi-opt.pw.patch%2CNONE%2C1.1%20psi-status_history.patch%2CNONE%2C1.1%20psi-status_indicator-cvs.patch%2CNONE%2C1.1%20psi-status_indicator.patch%2CNONE%2C1.1%20psi-translations.pw.patch%2CNONE%2C1.1%20psi.pwbuild%2CNONE%2C1.1%20psi.pwinfo%2CNONE%2C1.1%20uic-wrapper%2CNONE%2C1.1&In-Reply-To=%3C200407302034.i6UKYu622486%40bat.berlios.de%3E"
       TITLE="[Packware-cvs] pwbuild/xap/psi indicator.png,NONE,1.1 psi-cvs.pwbuild,NONE,1.1 psi-enable-mng.pw.patch,NONE,1.1 psi-no_default_status_text.patch,NONE,1.1 psi-no_online_status.patch,NONE,1.1 psi-offline_status.patch,NONE,1.1 psi-opt.pw.patch,NONE,1.1 psi-status_history.patch,NONE,1.1 psi-status_indicator-cvs.patch,NONE,1.1 psi-status_indicator.patch,NONE,1.1 psi-translations.pw.patch,NONE,1.1 psi.pwbuild,NONE,1.1 psi.pwinfo,NONE,1.1 uic-wrapper,NONE,1.1">nobody at sheep.berlios.de
       </A><BR>
    <I>Fri Jul 30 22:34:56 CEST 2004</I>
    <P><UL>
        <LI>Previous message: <A HREF="000049.html">[Packware-cvs] pwbuild/xap/psi - New directory
</A></li>
        <LI>Next message: <A HREF="000051.html">[Packware-cvs] pwbuild/ap - New directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Update of /cvsroot/packware/pwbuild/xap/psi
In directory sheep:/tmp/cvs-serv3049

Added Files:
	indicator.png psi-cvs.pwbuild psi-enable-mng.pw.patch 
	psi-no_default_status_text.patch psi-no_online_status.patch 
	psi-offline_status.patch psi-opt.pw.patch 
	psi-status_history.patch psi-status_indicator-cvs.patch 
	psi-status_indicator.patch psi-translations.pw.patch 
	psi.pwbuild psi.pwinfo uic-wrapper 
Log Message:
- Initial commit.
- Version 0.9.2/20040730.


--- NEW FILE: indicator.png ---
(This appears to be a binary file; contents omitted.)

--- NEW FILE: psi-cvs.pwbuild ---
#!/bin/sh

name=&quot;psi&quot;
version=&quot;20040730&quot;
build=&quot;1&quot;

_pwbuilder 0.6.4

_doc -d ChangeLog -x CVS

_source -m f0abfdb90e302070cf861ec46848c98c -s 1816833 -t ${name}/${name} <A HREF="ftp://ftp.berlios.de/pub/packware/sources/">ftp://ftp.berlios.de/pub/packware/sources/</A>

_patch -p 0 translations
_patch no_online_status
_patch no_default_status_text
_patch status_history
_patch status_indicator-cvs

_have_libmng &amp;&amp; _patch enable-mng

_setexecdir ${src1}/../qca
_execindir cp README ${doc}/README.qca
_execindir _configure --prefix=/usr
_qconf_fix ${src1}/../qca/Makefile
_execindir _make
_execindir _install

if _have_sasl2; then
    _setexecdir ${src1}/../qca/plugins/qca-sasl
    _execindir cp README ${doc}/README.qca-sasl
    _execindir _configure
    _qconf_fix ${src1}/../qca/plugins/qca-sasl/Makefile
    _execindir _make
    _execindir _install
fi

if _have_openssl; then
    _setexecdir ${src1}/../qca/plugins/qca-tls
    _execindir cp README ${doc}/README.qca-tls
    _execindir _configure
    _qconf_fix ${src1}/../qca/plugins/qca-tls/Makefile
    _execindir _make
    _execindir _install
fi

_c_opt --prefix=/usr

_configure

( cd ${src1}/src ; qmake -o Makefile )
_qconf_fix ${src1}/src/Makefile

# If you get a 'double const' error, uncomment these lines:
#
# sed &quot;s}\$(QTDIR)/bin/uic}${src}/uic-wrapper}&quot; ${src1}/src/Makefile &gt; ${tmp}/uicfix
# cat ${tmp}/uicfix &gt; ${src1}/src/Makefile

_patch opt

_make
_install

rm ${pkg}/usr/share/psi/{COPYING,README}
ln -s ${docdir}/COPYING ${pkg}/usr/share/psi
ln -s ${docdir}/README ${pkg}/usr/share/psi

cp ${src}/indicator.png ${pkg}/usr/share/psi/iconsets/roster/default

# $Log: psi-cvs.pwbuild,v $
# Revision 1.1  2004/07/30 20:34:54  swiergot
# - Initial commit.
# - Version 0.9.2/20040730.
#

--- NEW FILE: psi-enable-mng.pw.patch ---
diff -ruN psi.orig/libpsi.pri psi/libpsi.pri
--- psi.orig/libpsi.pri	2003-10-07 09:27:52.000000000 +0200
+++ psi/libpsi.pri	2003-10-09 15:07:23.000000000 +0200
@@ -11,7 +11,7 @@
 
 	# psipng
 	CONFIG += psipng
-	#CONFIG += psimng # uncomment this if you're really brave, and you have libmng installed
+	CONFIG += psimng
 	PSIPNG_CPP = $$LIBPSI_CPP/psipng
 	include($$PSIPNG_CPP/psipng.pri)
 }

--- NEW FILE: psi-no_default_status_text.patch ---
diff -ru -X exclude psi-clean/src/psicon.cpp psi/src/psicon.cpp
--- psi-clean/src/psicon.cpp	Fri Oct 24 05:38:42 2003
+++ psi/src/psicon.cpp	Sun Oct 26 14:42:44 2003
@@ -739,10 +739,7 @@
 		}
 		else {
 			QString str;
-			if(d-&gt;lastStatusString.isEmpty())
-				str = tr(&quot;I am away from my computer.  Please leave a message.&quot;);
-			else
-				str = d-&gt;lastStatusString; // default to old away message
+			str = d-&gt;lastStatusString; // default to old away message
 
 			StatusSetDlg *w = new StatusSetDlg(this, makeStatus(x, str));
 			connect(w, SIGNAL(set(const Status &amp;)), SLOT(setStatusFromDialog(const Status &amp;)));

--- NEW FILE: psi-no_online_status.patch ---
diff -ru psi/src/psiaccount.cpp psi-smk2/src/psiaccount.cpp
--- psi/src/psiaccount.cpp	2003-06-17 05:46:02.000000000 +0200
+++ psi-smk2/src/psiaccount.cpp	2003-06-19 23:48:40.000000000 +0200
@@ -1043,8 +1043,8 @@
 	Status s = _s;
 	s.setPriority(d-&gt;acc.priority);
 
-	if(s.status().isEmpty())
-		s.setStatus(status2txt(makeSTATUS(s)));
+//	if(s.status().isEmpty())
+//		s.setStatus(status2txt(makeSTATUS(s)));
 
 	//printf(&quot;setting status to [%s]\n&quot;, s.status().latin1());
 
@@ -1551,7 +1551,7 @@
 	}
 	else {
 		if(x == STATUS_ONLINE &amp;&amp; !option.askOnline) {
-			setStatus(Status());
+			setStatus(Status(&quot;&quot;,&quot;&quot;,0,true));
 		}
 		else if(x == STATUS_INVISIBLE){
 			Status s(&quot;&quot;,&quot;&quot;,0,true);

--- NEW FILE: psi-offline_status.patch ---
diff -ru -X exclude psi-clean/src/common.h psi/src/common.h
--- psi-clean/src/common.h	Tue Jan 27 18:09:30 2004
+++ psi/src/common.h	Sun Feb 15 20:29:30 2004
@@ -84,7 +84,7 @@
 	QMap&lt;QString, QString&gt; serviceRosterIconset;
 	QMap&lt;QString, QString&gt; customRosterIconset;
 
-	bool useleft, singleclick, askOnline, popupMsgs, popupChats, popupHeadlines, raise;
+	bool useleft, singleclick, askOnline, askOffline, popupMsgs, popupChats, popupHeadlines, raise;
 	bool alwaysOnTop, noAwaySound, noAwayPopup, noUnlistedPopup, rosterAnim, autoVersion, autoVCardOnLogin, xmlConsoleOnLogin;
 	bool useDock, dockDCstyle, dockHideMW, dockToolMW, isWMDock;
 	bool smallChats;
diff -ru -X exclude psi-clean/src/options/opt_status-ui.ui psi/src/options/opt_status-ui.ui
--- psi-clean/src/options/opt_status-ui.ui	Fri Dec 05 16:44:28 2003
+++ psi/src/options/opt_status-ui.ui	Sun Feb 15 20:33:28 2004
@@ -8,8 +8,8 @@
         &lt;rect&gt;
             &lt;x&gt;0&lt;/x&gt;
             &lt;y&gt;0&lt;/y&gt;
-            &lt;width&gt;330&lt;/width&gt;
-            &lt;height&gt;367&lt;/height&gt;
+            &lt;width&gt;221&lt;/width&gt;
+            &lt;height&gt;402&lt;/height&gt;
         &lt;/rect&gt;
     &lt;/property&gt;
     &lt;property name=&quot;caption&quot;&gt;
@@ -25,13 +25,34 @@
         &lt;property name=&quot;spacing&quot;&gt;
             &lt;number&gt;2&lt;/number&gt;
         &lt;/property&gt;
-        &lt;widget class=&quot;QCheckBox&quot;&gt;
+        &lt;widget class=&quot;QGroupBox&quot;&gt;
             &lt;property name=&quot;name&quot;&gt;
-                &lt;cstring&gt;ck_askOnline&lt;/cstring&gt;
+                &lt;cstring&gt;groupBox1&lt;/cstring&gt;
             &lt;/property&gt;
-            &lt;property name=&quot;text&quot;&gt;
-                &lt;string&gt;Prompt for status message when choosing &quot;Online&quot;&lt;/string&gt;
+            &lt;property name=&quot;title&quot;&gt;
+                &lt;string&gt;Prompt for status message when choosing&lt;/string&gt;
             &lt;/property&gt;
+            &lt;vbox&gt;
+                &lt;property name=&quot;name&quot;&gt;
+                    &lt;cstring&gt;unnamed&lt;/cstring&gt;
+                &lt;/property&gt;
+                &lt;widget class=&quot;QCheckBox&quot;&gt;
+                    &lt;property name=&quot;name&quot;&gt;
+                        &lt;cstring&gt;ck_askOnline&lt;/cstring&gt;
+                    &lt;/property&gt;
+                    &lt;property name=&quot;text&quot;&gt;
+                        &lt;string&gt;Online&lt;/string&gt;
+                    &lt;/property&gt;
+                &lt;/widget&gt;
+                &lt;widget class=&quot;QCheckBox&quot;&gt;
+                    &lt;property name=&quot;name&quot;&gt;
+                        &lt;cstring&gt;ck_askOffline&lt;/cstring&gt;
+                    &lt;/property&gt;
+                    &lt;property name=&quot;text&quot;&gt;
+                        &lt;string&gt;Offline&lt;/string&gt;
+                    &lt;/property&gt;
+                &lt;/widget&gt;
+            &lt;/vbox&gt;
         &lt;/widget&gt;
         &lt;widget class=&quot;QLayoutWidget&quot;&gt;
             &lt;property name=&quot;name&quot;&gt;
@@ -295,7 +316,6 @@
     &lt;/connection&gt;
 &lt;/connections&gt;
 &lt;tabstops&gt;
-    &lt;tabstop&gt;ck_askOnline&lt;/tabstop&gt;
     &lt;tabstop&gt;ck_asAway&lt;/tabstop&gt;
     &lt;tabstop&gt;sb_asAway&lt;/tabstop&gt;
     &lt;tabstop&gt;ck_asXa&lt;/tabstop&gt;
diff -ru -X exclude psi-clean/src/options/opt_status.cpp psi/src/options/opt_status.cpp
--- psi-clean/src/options/opt_status.cpp	Sat Jan 17 15:48:14 2004
+++ psi/src/options/opt_status.cpp	Sun Feb 15 20:29:38 2004
@@ -102,6 +102,7 @@
 	opt-&gt;sp = o-&gt;sp;
 
 	opt-&gt;askOnline = d-&gt;ck_askOnline-&gt;isChecked();
+	opt-&gt;askOffline = d-&gt;ck_askOffline-&gt;isChecked();
 }
 
 void OptionsTabStatus::restoreOptions(const Options *opt)
@@ -135,6 +136,7 @@
 		d-&gt;lb_sp-&gt;setSelected(0, TRUE);
 
 	d-&gt;ck_askOnline-&gt;setChecked( opt-&gt;askOnline );
+	d-&gt;ck_askOffline-&gt;setChecked( opt-&gt;askOffline );
 }
 
 void OptionsTabStatus::setData(PsiCon *, QWidget *parentDialog)
diff -ru -X exclude psi-clean/src/psiaccount.cpp psi/src/psiaccount.cpp
--- psi-clean/src/psiaccount.cpp	Tue Jan 27 18:09:36 2004
+++ psi/src/psiaccount.cpp	Sun Feb 15 21:15:12 2004
@@ -801,7 +801,7 @@
 }
 
 // disconnect or stop reconnecting
-void PsiAccount::logout(bool fast)
+void PsiAccount::logout(bool fast, const Status &amp;s)
 {
 	if(!isActive())
 		return;
@@ -811,7 +811,6 @@
 
 	if(loggedIn()) {
 		// send logout status
-		Status s(&quot;&quot;, &quot;Logged out&quot;, 0, false);
 		d-&gt;client-&gt;setPresence(s);
 	}
 
@@ -822,6 +821,13 @@
 	v_isActive = false;
 	stateChanged();
 
+	QTimer::singleShot(0, this, SLOT(disconnect()));
+}
+
+// skz note: I had to split logout() because server seem to need some time to store status
+// before stream is closed (weird, I know)
+void PsiAccount::disconnect()
+{
 	// disconnect
 	d-&gt;client-&gt;close();
 	cleanupStream();
@@ -1546,7 +1552,7 @@
 	}
 	else {
 		if(isActive())
-			logout();
+			logout(false, s);
 	}
 }
 
@@ -2070,7 +2076,7 @@
 
 void PsiAccount::changeStatus(int x)
 {
-	if(x == STATUS_OFFLINE) {
-		setStatus(Status(&quot;&quot;,&quot;&quot;,0,false));
+	if(x == STATUS_OFFLINE &amp;&amp; !option.askOffline) {
+		setStatus(Status(&quot;&quot;,&quot;Logged out&quot;,0,false));
 	}
 	else {
diff -ru -X exclude psi-clean/src/psiaccount.h psi/src/psiaccount.h
--- psi-clean/src/psiaccount.h	Tue Jan 27 18:09:36 2004
+++ psi/src/psiaccount.h	Sun Feb 15 21:10:44 2004
@@ -149,7 +149,7 @@
 	void setStatusDirect(const Status &amp;);
 	void setStatusActual(const Status &amp;);
 	void login();
-	void logout(bool fast=false);
+	void logout(bool fast=false, const Status &amp;s = Status(&quot;&quot;, &quot;Logged out&quot;, 0, false));
 	bool loggedIn() const;
 	void setNick(const QString &amp;);
 	QString nick() const;
@@ -289,6 +289,7 @@
 	void client_incomingJidLink();
 
 	void reconnect();
+	void disconnect();
 	void enableNotifyOnline();
 
 	void slotClientVersionFinished();
diff -ru -X exclude psi-clean/src/psicon.cpp psi/src/psicon.cpp
--- psi-clean/src/psicon.cpp	Thu Feb 12 22:47:38 2004
+++ psi/src/psicon.cpp	Sun Feb 15 20:30:02 2004
@@ -757,7 +757,7 @@
 
 void PsiCon::statusMenuChanged(int x)
 {
-	if(x == STATUS_OFFLINE) {
-		setGlobalStatus(Status(&quot;&quot;,&quot;&quot;,0,false));
+	if(x == STATUS_OFFLINE &amp;&amp; !option.askOffline) {
+		setGlobalStatus(Status(&quot;&quot;,&quot;Logged out&quot;,0,false));
 		if(option.useDock == true)
 			d-&gt;mainwin-&gt;setTrayToolTip(Status(&quot;&quot;,&quot;&quot;,0,false));
diff -ru -X exclude psi-clean/src/psi_profiles.cpp psi/src/psi_profiles.cpp
--- psi-clean/src/psi_profiles.cpp	Tue Jan 27 18:09:32 2004
+++ psi/src/psi_profiles.cpp	Sun Feb 15 20:29:48 2004
@@ -363,6 +363,7 @@
 	prefs.raise = FALSE;
 	prefs.incomingAs = 0;
 	prefs.askOnline = FALSE;
+	prefs.askOffline = FALSE;
 	prefs.rosterAnim = TRUE;
 	prefs.autoVersion = false;
 	prefs.autoVCardOnLogin = true;
@@ -724,6 +725,7 @@
 			p_pres.appendChild(tag);
 
 			tag.appendChild(textTag(doc, &quot;askOnline&quot;, prefs.askOnline));
+			tag.appendChild(textTag(doc, &quot;askOffline&quot;, prefs.askOffline));
 			tag.appendChild(textTag(doc, &quot;rosterAnim&quot;, prefs.rosterAnim));
 			tag.appendChild(textTag(doc, &quot;autoVersion&quot;, prefs.autoVersion));
 			tag.appendChild(textTag(doc, &quot;autoVCardOnLogin&quot;, prefs.autoVCardOnLogin));
@@ -1186,6 +1188,7 @@
 			QDomElement tag = findSubTag(p_pres, &quot;misc&quot;, &amp;found);
 			if(found) {
 				readBoolEntry(tag, &quot;askOnline&quot;, &amp;prefs.askOnline);
+				readBoolEntry(tag, &quot;askOffline&quot;, &amp;prefs.askOffline);
 				readBoolEntry(tag, &quot;rosterAnim&quot;, &amp;prefs.rosterAnim);
 				readBoolEntry(tag, &quot;autoVersion&quot;, &amp;prefs.autoVersion);
 				readBoolEntry(tag, &quot;autoVCardOnLogin&quot;, &amp;prefs.autoVCardOnLogin);
diff -ru -X exclude psi-clean/src/statusdlg.cpp psi/src/statusdlg.cpp
--- psi-clean/src/statusdlg.cpp	Sun Jan 04 20:30:30 2004
+++ psi/src/statusdlg.cpp	Sun Feb 15 20:38:54 2004
@@ -65,7 +65,7 @@
 //----------------------------------------------------------------------------
 // StatusSetDlg
 //----------------------------------------------------------------------------
-static int combomap[6] = { STATUS_CHAT, STATUS_ONLINE, STATUS_AWAY, STATUS_XA, STATUS_DND, STATUS_INVISIBLE };
+static int combomap[7] = { STATUS_CHAT, STATUS_ONLINE, STATUS_AWAY, STATUS_XA, STATUS_DND, STATUS_INVISIBLE, STATUS_OFFLINE };
 
 class StatusSetDlg::Private
 {
@@ -119,9 +119,9 @@
 	hb1-&gt;addWidget(l);
 	d-&gt;cb_type = new QComboBox(this);
 	int n;
-	for(n = 0; n &lt; 6; ++n)
+	for(n = 0; n &lt; 7; ++n)
 		d-&gt;cb_type-&gt;insertItem(status2txt(combomap[n]));
-	for(n = 0; n &lt; 6; ++n) {
+	for(n = 0; n &lt; 7; ++n) {
 		if(type == combomap[n]) {
 			d-&gt;cb_type-&gt;setCurrentItem(n);
 			break;

--- NEW FILE: psi-opt.pw.patch ---
diff -ruN psi.orig/src/Makefile psi/src/Makefile
--- psi.orig/src/Makefile	2003-10-05 19:28:29.000000000 +0200
+++ psi/src/Makefile	2003-10-05 19:29:58.000000000 +0200
@@ -62,19 +62,19 @@
 .SUFFIXES: .c .cpp .cc .cxx .C
 
 .cpp.o:
-	$(CXX) -c $(CXXFLAGS) $(INCPATH) -o $@ $&lt;
+	$(CXX) -c $(CXXFLAGS) $(INCPATH) $(AM_CFLAGS) -o $@ $&lt;
 
 .cc.o:
-	$(CXX) -c $(CXXFLAGS) $(INCPATH) -o $@ $&lt;
+	$(CXX) -c $(CXXFLAGS) $(INCPATH) $(AM_CFLAGS) -o $@ $&lt;
 
 .cxx.o:
-	$(CXX) -c $(CXXFLAGS) $(INCPATH) -o $@ $&lt;
+	$(CXX) -c $(CXXFLAGS) $(INCPATH) $(AM_CFLAGS) -o $@ $&lt;
 
 .C.o:
-	$(CXX) -c $(CXXFLAGS) $(INCPATH) -o $@ $&lt;
+	$(CXX) -c $(CXXFLAGS) $(INCPATH) $(AM_CFLAGS) -o $@ $&lt;
 
 .c.o:
-	$(CC) -c $(CFLAGS) $(INCPATH) -o $@ $&lt;
+	$(CC) -c $(CFLAGS) $(INCPATH) $(AM_CFLAGS) -o $@ $&lt;
 
 ####### Build rules
 

--- NEW FILE: psi-status_history.patch ---
diff -urN psi-old/src/common.h psi/src/common.h
--- psi-old/src/common.h	2004-02-18 16:45:00.564143280 +0100
+++ psi/src/common.h	2004-02-18 16:46:26.719045744 +0100
@@ -93,6 +93,8 @@
 	int defaultAction;
 	int incomingAs;
 	VarList sp; //status message presets
+	int recentStatusLimit;
+	bool storePresets;
 	QStringList recentStatus; //recent status messages
 
 	int asAway, asXa, asOffline;
diff -urN psi-old/src/psi_profiles.cpp psi/src/psi_profiles.cpp
--- psi-old/src/psi_profiles.cpp	2004-02-18 16:45:00.650130208 +0100
+++ psi/src/psi_profiles.cpp	2004-02-18 16:46:26.791034800 +0100
@@ -397,6 +397,8 @@
 	prefs.sp.set(QObject::tr(&quot;Out for the night&quot;), QObject::tr(&quot;Out for the night.&quot;));
 	prefs.sp.set(QObject::tr(&quot;Greece&quot;), QObject::tr(&quot;I have gone to a far away place.  I will be back someday!&quot;));
 	prefs.recentStatus.clear();
+	prefs.recentStatusLimit = 5;
+	prefs.storePresets = true;
 
 	prefs.color[cOnline]    = QColor(&quot;#0060C0&quot;);
 	prefs.color[cListBack]  = QColor(&quot;#C0C0C0&quot;);
@@ -754,7 +756,12 @@
 			p_pres.appendChild(prefs.sp.toXml(doc, &quot;statuspresets&quot;));
 		}
 		{
-			p_pres.appendChild(stringListToXml(doc, &quot;recentstatus&quot;,prefs.recentStatus));
+			QDomElement e;
+			
+			e = stringListToXml(doc, &quot;recentstatus&quot;,prefs.recentStatus);
+			e.setAttribute(&quot;limit&quot;, prefs.recentStatusLimit);
+			setBoolAttribute(e, &quot;storePresets&quot;, prefs.storePresets);
+			p_pres.appendChild(e);
 		}
 	}
 
@@ -1230,7 +1237,14 @@
 			tag = findSubTag(p_pres, &quot;statuspresets&quot;, &amp;found);
 			if(found)
 				prefs.sp.fromXml(tag);
-			xmlToStringList(p_pres, &quot;recentstatus&quot;, &amp;prefs.recentStatus);
+			tag = findSubTag(p_pres, &quot;recentstatus&quot;, &amp;found);
+			if(found){
+				if(tag.hasAttribute(&quot;limit&quot;))
+					prefs.recentStatusLimit = tag.attribute(&quot;limit&quot;).toInt();
+				if(tag.hasAttribute(&quot;storePresets&quot;))
+					readBoolAttribute(tag, &quot;storePresets&quot;, &amp;prefs.storePresets);
+				xmlToStringList(p_pres, &quot;recentstatus&quot;, &amp;prefs.recentStatus);
+			}
 		}
 
 		QDomElement p_lnf = findSubTag(p, &quot;lookandfeel&quot;, &amp;found);
diff -urN psi-old/src/statusdlg.cpp psi/src/statusdlg.cpp
--- psi-old/src/statusdlg.cpp	2004-02-18 16:45:00.699122760 +0100
+++ psi/src/statusdlg.cpp	2004-02-18 16:46:26.792034648 +0100
@@ -72,6 +72,8 @@
 public:
 	Private() {}
 
+	int recentNum;
+	QString newStatus;
 	PsiCon *psi;
 	PsiAccount *pa;
 	Status s;
@@ -88,6 +90,7 @@
 	d-&gt;pa = 0;
 	d-&gt;psi-&gt;dialogRegister(this);
 	d-&gt;s = s;
+	d-&gt;recentNum = -1;
 
 	setCaption(CAP(tr(&quot;Set Status: All accounts&quot;)));
 	init();
@@ -101,6 +104,7 @@
 	d-&gt;pa = pa;
 	d-&gt;pa-&gt;dialogRegister(this);
 	d-&gt;s = s;
+	d-&gt;recentNum = -1;
 
 	setCaption(CAP(tr(&quot;Set Status: %1&quot;).arg(d-&gt;pa-&gt;name())));
 	init();
@@ -159,6 +163,8 @@
 	d-&gt;te-&gt;setTextFormat(PlainText);
 	d-&gt;te-&gt;setText(d-&gt;s.status());
 	d-&gt;te-&gt;selectAll();
+	d-&gt;te-&gt;installEventFilter( this );
+	d-&gt;newStatus = d-&gt;te-&gt;text();
 	connect(pb1, SIGNAL(clicked()), SLOT(doButton()));
 	connect(pb2, SIGNAL(clicked()), SLOT(cancel()));
 	d-&gt;te-&gt;setFocus();
@@ -185,6 +191,37 @@
 		e-&gt;ignore();
 }
 
+bool StatusSetDlg::eventFilter( QObject *o, QEvent *e )
+{
+	if ( e-&gt;type() == QEvent::KeyPress ) {
+		QKeyEvent *ke = (QKeyEvent*)e;
+		if(ke-&gt;key() == Key_Up &amp;&amp; (ke-&gt;state() &amp; AltButton) )
+			return historySelect(-1);
+		else if(ke-&gt;key() == Key_Down &amp;&amp; (ke-&gt;state() &amp; AltButton) )
+			return historySelect(1);
+	}
+	return FALSE; 
+}
+
+bool StatusSetDlg::historySelect(int offs)
+{
+	// d-&gt;recentNum == -1 is new status (not saved yet)
+	if(d-&gt;recentNum == -1 &amp;&amp; offs &gt; 0)
+		d-&gt;newStatus = d-&gt;te-&gt;text();
+	else if(d-&gt;recentNum == 0 &amp;&amp; offs &lt; 0){
+		d-&gt;te-&gt;setText(d-&gt;newStatus);
+		d-&gt;recentNum += offs;
+		return TRUE;
+	}
+
+	if((d-&gt;recentNum + offs &lt; 0) || (d-&gt;recentNum + offs &gt;= (int)option.recentStatus.count()))
+		return FALSE;
+
+	d-&gt;recentNum += offs;
+	d-&gt;te-&gt;setText(option.recentStatus[d-&gt;recentNum]);	
+	return TRUE;
+}
+
 void StatusSetDlg::doButton()
 {
 	// Save preset
@@ -220,6 +257,17 @@
 	int type = combomap[d-&gt;cb_type-&gt;currentItem()];
 	QString str = d-&gt;te-&gt;text();
 
+	// save recent if not saved yet else bring to front
+	if(!str.isEmpty()){
+		option.recentStatus.remove(str);
+		// if status is from preset, don't save it unless storePresets = &quot;true&quot; (config.xml)
+		if(option.storePresets || option.sp.findByData(str) == option.sp.end())
+			option.recentStatus.push_front(str);
+	}
+	// trim 
+	if((int)option.recentStatus.size() &gt; option.recentStatusLimit)
+		option.recentStatus.pop_back();
+	
 	set(makeStatus(type, str));
 	close();
 }
diff -urN psi-old/src/statusdlg.h psi/src/statusdlg.h
--- psi-old/src/statusdlg.h	2004-02-18 16:45:00.511151336 +0100
+++ psi/src/statusdlg.h	2004-02-18 16:46:26.824029784 +0100
@@ -47,6 +47,8 @@
 
 protected:
 	void keyPressEvent(QKeyEvent *);
+	bool eventFilter(QObject *, QEvent *);
+	bool historySelect(int);
 
 signals:
 	void set(const Status &amp;);
diff -urN psi-old/src/varlist.cpp psi/src/varlist.cpp
--- psi-old/src/varlist.cpp	2004-02-18 16:45:00.622134464 +0100
+++ psi/src/varlist.cpp	2004-02-18 16:46:26.856024920 +0100
@@ -105,6 +105,17 @@
 	return it;
 }
 
+VarList::Iterator VarList::findByData(const QString &amp;data)
+{
+	VarList::Iterator it;
+	for(it = begin(); it != end(); ++it) {
+		if((*it).data() == data)
+			break;
+	}
+
+	return it;
+}
+
 VarList::Iterator VarList::findByNum(int x)
 {
 	int n = 0;
diff -urN psi-old/src/varlist.h psi/src/varlist.h
--- psi-old/src/varlist.h	2004-02-18 16:45:00.623134312 +0100
+++ psi/src/varlist.h	2004-02-18 16:46:26.886020360 +0100
@@ -53,6 +53,7 @@
 	const QString &amp; get(const QString &amp;);
 
 	VarList::Iterator findByKey(const QString &amp;);
+	VarList::Iterator findByData(const QString &amp;);
 	VarList::Iterator findByNum(int);
 
 	QStringList varsToStringList();

--- NEW FILE: psi-status_indicator-cvs.patch ---
diff -ru -X exclude ../../iris-clean/xmpp-im/client.cpp ../../iris/xmpp-im/client.cpp
--- ../../iris-clean/xmpp-im/client.cpp	Tue Feb 24 19:45:40 2004
+++ ../../iris/xmpp-im/client.cpp	Thu Apr 15 07:05:08 2004
@@ -792,10 +792,27 @@
 
 	// unavailable?  remove the resource
 	if(!s.isAvailable()) {
-		if(found) {
-			(*rit).setStatus(s);
-			debug(QString(&quot;Client: Removing resource from [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource()));
-			resourceUnavailable(j, *rit);
+		Resource r;
+		if(!found) {
+			//if (!s.status().isEmpty()) {
+				r = Resource(j.resource(), s);
+				i-&gt;resourceList() += r;
+				debug(QString(&quot;Client: Adding resource to [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource()));
+				resourceAvailable(j, r);
+		} 
+		else {
+				(*rit).setStatus(s);
+				r = *rit;
+				debug(QString(&quot;Client: Updating resource to [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource()));
+				resourceAvailable(j, r);			
+		}
+		
+		rit = i-&gt;resourceList().find(j.resource());
+		found = (rit == i-&gt;resourceList().end()) ? false: true;
+		
+ 		if(found) {
+ 			(*rit).setStatus(s);
+ 			debug(QString(&quot;Client: Removing resource from [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource())); 	resourceUnavailable(j, *rit);
 			i-&gt;resourceList().remove(rit);
 			i-&gt;setLastUnavailableStatus(s);
 		}
diff -ru -X exclude psi-clean/src/chatdlg.cpp psi/src/chatdlg.cpp
--- psi-clean/src/chatdlg.cpp	Thu Apr 01 09:44:42 2004
+++ psi/src/chatdlg.cpp	Thu Apr 15 07:05:08 2004
@@ -366,8 +366,10 @@
 			u = ul.first();
 			if(rname.isEmpty()) {
 				// use priority
-				if(!u-&gt;isAvailable())
+				if(!u-&gt;isAvailable()){
 					status = STATUS_OFFLINE;
+					statusString = u-&gt;lastUnavailableStatus().status();
+				}
 				else {
 					const UserResource &amp;r = *u-&gt;userResourceList().priority();
 					status = makeSTATUS(r.status());
diff -ru -X exclude psi-clean/src/common.h psi/src/common.h
--- psi-clean/src/common.h	Thu Mar 04 22:04:00 2004
+++ psi/src/common.h	Thu Apr 15 07:05:08 2004
@@ -138,6 +138,7 @@
 	QStringList gcHighlights, gcNickColors;
 
 	bool clNewHeadings;
+	bool clStIndicator;
 
 	// passive popups
 	bool ppIsOn;
diff -ru -X exclude psi-clean/src/contactview.cpp psi/src/contactview.cpp
--- psi-clean/src/contactview.cpp	Sun Mar 21 15:45:20 2004
+++ psi/src/contactview.cpp	Thu Apr 15 08:30:14 2004
@@ -25,6 +25,7 @@
 #include&lt;qheader.h&gt;
 #include&lt;qtimer.h&gt;
 #include&lt;qpainter.h&gt;
+#include&lt;qbitmap.h&gt;
 #include&lt;qpopupmenu.h&gt;
 #include&lt;qmessagebox.h&gt;
 #include&lt;qinputdialog.h&gt;
@@ -2652,12 +2751,13 @@
 
 void ContactViewItem::setIcon(const Icon *icon, bool alert)
 {
+	/* needed by status indicator :o|
 	if ( d-&gt;lastIcon == icon ) {
 		return; // cause less flicker. but still have to run calltree valgring skin on psi while online (mblsha).
 	}
 	else
 		d-&gt;lastIcon = (Icon *)icon;
-
+	*/
 	if ( d-&gt;icon ) {
 		disconnect(d-&gt;icon, 0, this, 0 );
 		d-&gt;icon-&gt;stop();
@@ -2679,12 +2779,42 @@
 		pix = d-&gt;icon-&gt;pixmap();
 	}
 
-	setPixmap(0, pix);
+	iconUpdated(pix);
 }
 
 void ContactViewItem::iconUpdated(const QPixmap &amp;pix)
 {
-	setPixmap(0, pix);
+	QPixmap out(pix);
+	// add status indicator to contact icon
+	if(d-&gt;u &amp;&amp; !out.isNull()){
+		bool ind = false;
+		if(!d-&gt;u-&gt;userResourceList().isEmpty() &amp;&amp; option.clStIndicator) {
+			UserResourceList srl = d-&gt;u-&gt;userResourceList();
+
+			for(UserResourceList::ConstIterator rit = srl.begin(); rit != srl.end(); ++rit)
+				if(!(*rit).status().status().isEmpty()) { ind = true; break; }
+			
+		} 
+		else if(!d-&gt;u-&gt;lastUnavailableStatus().status().isEmpty() &amp;&amp; option.clStIndicator)
+			ind = true;
+
+		if(ind) {
+			const QPixmap &amp;ipix = is-&gt;indicator(d-&gt;u-&gt;jid()).pixmap();
+			// sum masks
+			if(out.hasAlpha() &amp;&amp; ipix.hasAlpha()){
+				QBitmap mask(*out.mask());
+				const QBitmap* imask = ipix.mask();
+				bitBlt(&amp;mask, (mask.width() - imask-&gt;width())/2, (mask.height() - imask-&gt;height())/2, 
+					imask, 0, 0, imask-&gt;width(), imask-&gt;height(), 
+					Qt::OrROP);
+				out.setMask(mask);
+			}
+			bitBlt(&amp;out, (out.width() - ipix.width())/2, (out.height() - ipix.height())/2, 
+				&amp;ipix, 0, 0, ipix.width(), ipix.height(), 
+				Qt::CopyROP);
+		}
+	}
+	setPixmap(0, out);
 }
 
 void ContactViewItem::animateNick()
diff -ru -X exclude psi-clean/src/options/opt_appearance-ui.ui psi/src/options/opt_appearance-ui.ui
--- psi-clean/src/options/opt_appearance-ui.ui	Thu Dec 11 16:44:18 2003
+++ psi/src/options/opt_appearance-ui.ui	Thu Apr 15 07:05:08 2004
@@ -30,6 +30,14 @@
                 &lt;string&gt;Small group headings in roster&lt;/string&gt;
             &lt;/property&gt;
         &lt;/widget&gt;
+        &lt;widget class=&quot;QCheckBox&quot;&gt;
+            &lt;property name=&quot;name&quot;&gt;
+                &lt;cstring&gt;ck_statusIndicator&lt;/cstring&gt;
+            &lt;/property&gt;
+            &lt;property name=&quot;text&quot;&gt;
+                &lt;string&gt;Show indicator for text statuses&lt;/string&gt;
+            &lt;/property&gt;
+        &lt;/widget&gt;
         &lt;widget class=&quot;QGroupBox&quot;&gt;
             &lt;property name=&quot;name&quot;&gt;
                 &lt;cstring&gt;groupBox11&lt;/cstring&gt;
diff -ru -X exclude psi-clean/src/options/opt_appearance.cpp psi/src/options/opt_appearance.cpp
--- psi-clean/src/options/opt_appearance.cpp	Tue Dec 02 14:28:58 2003
+++ psi/src/options/opt_appearance.cpp	Thu Apr 15 07:05:08 2004
@@ -112,6 +112,9 @@
 	QWhatsThis::add(d-&gt;pb_cAnimBack,
 		tr(&quot;Specifies the background animation color for nicks.&quot;));
 
+	QWhatsThis::add(d-&gt;ck_statusIndicator,
+		tr(&quot;Displays an indicator by the contact name if the contact entered a descriptive text status line.&quot;));
+
 	QWhatsThis::add(d-&gt;ck_newHeadings,
 		tr(&quot;Toggles on new, smaller group headings.&quot;));
 
@@ -125,6 +128,7 @@
 
 	OptAppearanceUI *d = (OptAppearanceUI *)w;
 	opt-&gt;clNewHeadings = d-&gt;ck_newHeadings-&gt;isChecked();
+	opt-&gt;clStIndicator = d-&gt;ck_statusIndicator-&gt;isChecked();
 
 	int n;
 	for (n = 0; n &lt; 3; ++n)
@@ -141,6 +145,7 @@
 
 	OptAppearanceUI *d = (OptAppearanceUI *)w;
 	d-&gt;ck_newHeadings-&gt;setChecked( opt-&gt;clNewHeadings );
+	d-&gt;ck_statusIndicator-&gt;setChecked( opt-&gt;clStIndicator );
 
 	int n;
 	for (n = 0; n &lt; 3; ++n)
diff -ru -X exclude psi-clean/src/psiiconset.cpp psi/src/psiiconset.cpp
--- psi-clean/src/psiiconset.cpp	Sun Jan 25 14:52:04 2004
+++ psi/src/psiiconset.cpp	Thu Apr 15 07:05:08 2004
@@ -510,6 +510,19 @@
 	return Icon();
 }
 
+Icon *PsiIconset::indicatorPtr(const XMPP::Jid &amp;jid)
+{
+	return d-&gt;jid2icon(jid, &quot;psi/statInd&quot;);
+}
+
+Icon PsiIconset::indicator(const XMPP::Jid &amp;jid)
+{
+	Icon *icon = indicatorPtr(jid);
+	if ( icon )
+		return *icon;
+	return Icon();
+}
+
 Icon *PsiIconset::statusPtr(const XMPP::Jid &amp;jid, int s)
 {
 	return d-&gt;jid2icon(jid, status2name(s));
diff -ru -X exclude psi-clean/src/psiiconset.h psi/src/psiiconset.h
--- psi-clean/src/psiiconset.h	Sat Nov 22 07:47:10 2003
+++ psi/src/psiiconset.h	Thu Apr 15 07:05:08 2004
@@ -61,9 +61,11 @@
 	// JID-enabled status functions
 	Icon *statusPtr(const XMPP::Jid &amp;, int);
 	Icon *statusPtr(const XMPP::Jid &amp;, const XMPP::Status &amp;);
+	Icon *indicatorPtr(const XMPP::Jid &amp;);
 
 	Icon status(const XMPP::Jid &amp;, int);
 	Icon status(const XMPP::Jid &amp;, const XMPP::Status &amp;);
+	Icon indicator(const XMPP::Jid &amp;);
 
 	// functions to get status icon by transport name
 	Icon *transportStatusPtr(QString name, int);
diff -ru -X exclude psi-clean/src/psi_profiles.cpp psi/src/psi_profiles.cpp
--- psi-clean/src/psi_profiles.cpp	Sun Mar 21 15:47:06 2004
+++ psi/src/psi_profiles.cpp	Thu Apr 15 07:05:08 2004
@@ -423,6 +423,8 @@
 		prefs.font[fPopup] = font.toString();
 	}
 
+	prefs.clStIndicator = TRUE;
+
 	// calculate the small font size
 	const int minimumFontSize = 7;
 	prefs.smallFontSize = qApp-&gt;font().pointSize();
@@ -774,6 +776,7 @@
 		p.appendChild(p_lnf);
 
 		p_lnf.appendChild(textTag(doc, &quot;newHeadings&quot;, prefs.clNewHeadings));
+		p_lnf.appendChild(textTag(doc, &quot;statusIndicator&quot;, prefs.clStIndicator));
 
 		{
 			QDomElement tag = doc.createElement(&quot;colors&quot;);
@@ -1258,6 +1261,7 @@
 			bool found;
 
 			readBoolEntry(p_lnf, &quot;newHeadings&quot;, &amp;prefs.clNewHeadings);
+			readBoolEntry(p_lnf, &quot;statusIndicator&quot;, &amp;prefs.clStIndicator);
 
 			QDomElement tag = findSubTag(p_lnf, &quot;colors&quot;, &amp;found);
 			if(found) {
diff -ruN psi.orig/iconsets/roster/default/icondef.xml psi/iconsets/roster/default/icondef.xml
--- psi.orig/iconsets/roster/default/icondef.xml	2004-04-22 21:49:53.000000000 +0200
+++ psi/iconsets/roster/default/icondef.xml	2004-05-06 20:32:33.000000000 +0200
@@ -62,6 +62,11 @@
 		&lt;object mime='image/png'&gt;perr.png&lt;/object&gt;
 	&lt;/icon&gt;
 
+	&lt;icon&gt;
+		&lt;x xmlns='name'&gt;psi/statInd&lt;/x&gt;
+		&lt;object mime='image/png'&gt;indicator.png&lt;/object&gt;
+	&lt;/icon&gt;
+
 	&lt;!-- Special icons --&gt;
 	&lt;icon&gt;
 		&lt;x xmlns='name'&gt;psi/chat&lt;/x&gt;

--- NEW FILE: psi-status_indicator.patch ---
diff -ru -X exclude ../iris-clean/xmpp-im/client.cpp ../iris/xmpp-im/client.cpp
--- ../iris-clean/xmpp-im/client.cpp	Tue Feb 24 19:45:40 2004
+++ ../iris/xmpp-im/client.cpp	Thu Apr 15 07:05:08 2004
@@ -792,10 +792,27 @@
 
 	// unavailable?  remove the resource
 	if(!s.isAvailable()) {
-		if(found) {
-			(*rit).setStatus(s);
-			debug(QString(&quot;Client: Removing resource from [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource()));
-			resourceUnavailable(j, *rit);
+		Resource r;
+		if(!found) {
+			//if (!s.status().isEmpty()) {
+				r = Resource(j.resource(), s);
+				i-&gt;resourceList() += r;
+				debug(QString(&quot;Client: Adding resource to [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource()));
+				resourceAvailable(j, r);
+		} 
+		else {
+				(*rit).setStatus(s);
+				r = *rit;
+				debug(QString(&quot;Client: Updating resource to [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource()));
+				resourceAvailable(j, r);			
+		}
+		
+		rit = i-&gt;resourceList().find(j.resource());
+		found = (rit == i-&gt;resourceList().end()) ? false: true;
+		
+ 		if(found) {
+ 			(*rit).setStatus(s);
+ 			debug(QString(&quot;Client: Removing resource from [%1]: name=[%2]\n&quot;).arg(i-&gt;jid().full()).arg(j.resource())); 	resourceUnavailable(j, *rit);
 			i-&gt;resourceList().remove(rit);
 			i-&gt;setLastUnavailableStatus(s);
 		}
diff -ru -X exclude psi-clean/src/chatdlg.cpp psi/src/chatdlg.cpp
--- psi-clean/src/chatdlg.cpp	Thu Apr 01 09:44:42 2004
+++ psi/src/chatdlg.cpp	Thu Apr 15 07:05:08 2004
@@ -366,8 +366,10 @@
 			u = ul.first();
 			if(rname.isEmpty()) {
 				// use priority
-				if(!u-&gt;isAvailable())
+				if(!u-&gt;isAvailable()){
 					status = STATUS_OFFLINE;
+					statusString = u-&gt;lastUnavailableStatus().status();
+				}
 				else {
 					const UserResource &amp;r = *u-&gt;userResourceList().priority();
 					status = makeSTATUS(r.status());
diff -ru -X exclude psi-clean/src/common.h psi/src/common.h
--- psi-clean/src/common.h	Thu Mar 04 22:04:00 2004
+++ psi/src/common.h	Thu Apr 15 07:05:08 2004
@@ -138,6 +138,7 @@
 	QStringList gcHighlights, gcNickColors;
 
 	bool clNewHeadings;
+	bool clStIndicator;
 
 	// passive popups
 	bool ppIsOn;
diff -ru -X exclude psi-clean/src/contactview.cpp psi/src/contactview.cpp
--- psi-clean/src/contactview.cpp	Sun Mar 21 15:45:20 2004
+++ psi/src/contactview.cpp	Thu Apr 15 08:30:14 2004
@@ -25,6 +25,7 @@
 #include&lt;qheader.h&gt;
 #include&lt;qtimer.h&gt;
 #include&lt;qpainter.h&gt;
+#include&lt;qbitmap.h&gt;
 #include&lt;qpopupmenu.h&gt;
 #include&lt;qmessagebox.h&gt;
 #include&lt;qinputdialog.h&gt;
@@ -2652,12 +2751,13 @@
 
 void ContactViewItem::setIcon(const Icon *icon, bool alert)
 {
+	/* needed by status indicator :o|
 	if ( d-&gt;lastIcon == icon ) {
 		return; // cause less flicker. but still have to run calltree valgring skin on psi while online (mblsha).
 	}
 	else
 		d-&gt;lastIcon = (Icon *)icon;
-
+	*/
 	if ( d-&gt;icon ) {
 		disconnect(d-&gt;icon, 0, this, 0 );
 		d-&gt;icon-&gt;stop();
@@ -2679,12 +2779,42 @@
 		pix = d-&gt;icon-&gt;pixmap();
 	}
 
-	setPixmap(0, pix);
+	iconUpdated(pix);
 }
 
 void ContactViewItem::iconUpdated(const QPixmap &amp;pix)
 {
-	setPixmap(0, pix);
+	QPixmap out(pix);
+	// add status indicator to contact icon
+	if(d-&gt;u &amp;&amp; !out.isNull()){
+		bool ind = false;
+		if(!d-&gt;u-&gt;userResourceList().isEmpty() &amp;&amp; option.clStIndicator) {
+			UserResourceList srl = d-&gt;u-&gt;userResourceList();
+
+			for(UserResourceList::ConstIterator rit = srl.begin(); rit != srl.end(); ++rit)
+				if(!(*rit).status().status().isEmpty()) { ind = true; break; }
+			
+		} 
+		else if(!d-&gt;u-&gt;lastUnavailableStatus().status().isEmpty() &amp;&amp; option.clStIndicator)
+			ind = true;
+
+		if(ind) {
+			const QPixmap &amp;ipix = is-&gt;indicator(d-&gt;u-&gt;jid()).pixmap();
+			// sum masks
+			if(out.hasAlpha() &amp;&amp; ipix.hasAlpha()){
+				QBitmap mask(*out.mask());
+				const QBitmap* imask = ipix.mask();
+				bitBlt(&amp;mask, (mask.width() - imask-&gt;width())/2, (mask.height() - imask-&gt;height())/2, 
+					imask, 0, 0, imask-&gt;width(), imask-&gt;height(), 
+					Qt::OrROP);
+				out.setMask(mask);
+			}
+			bitBlt(&amp;out, (out.width() - ipix.width())/2, (out.height() - ipix.height())/2, 
+				&amp;ipix, 0, 0, ipix.width(), ipix.height(), 
+				Qt::CopyROP);
+		}
+	}
+	setPixmap(0, out);
 }
 
 void ContactViewItem::animateNick()
diff -ru -X exclude psi-clean/src/options/opt_appearance-ui.ui psi/src/options/opt_appearance-ui.ui
--- psi-clean/src/options/opt_appearance-ui.ui	Thu Dec 11 16:44:18 2003
+++ psi/src/options/opt_appearance-ui.ui	Thu Apr 15 07:05:08 2004
@@ -30,6 +30,14 @@
                 &lt;string&gt;Small group headings in roster&lt;/string&gt;
             &lt;/property&gt;
         &lt;/widget&gt;
+        &lt;widget class=&quot;QCheckBox&quot;&gt;
+            &lt;property name=&quot;name&quot;&gt;
+                &lt;cstring&gt;ck_statusIndicator&lt;/cstring&gt;
+            &lt;/property&gt;
+            &lt;property name=&quot;text&quot;&gt;
+                &lt;string&gt;Show indicator for text statuses&lt;/string&gt;
+            &lt;/property&gt;
+        &lt;/widget&gt;
         &lt;widget class=&quot;QGroupBox&quot;&gt;
             &lt;property name=&quot;name&quot;&gt;
                 &lt;cstring&gt;groupBox11&lt;/cstring&gt;
diff -ru -X exclude psi-clean/src/options/opt_appearance.cpp psi/src/options/opt_appearance.cpp
--- psi-clean/src/options/opt_appearance.cpp	Tue Dec 02 14:28:58 2003
+++ psi/src/options/opt_appearance.cpp	Thu Apr 15 07:05:08 2004
@@ -112,6 +112,9 @@
 	QWhatsThis::add(d-&gt;pb_cAnimBack,
 		tr(&quot;Specifies the background animation color for nicks.&quot;));
 
+	QWhatsThis::add(d-&gt;ck_statusIndicator,
+		tr(&quot;Displays an indicator by the contact name if the contact entered a descriptive text status line.&quot;));
+
 	QWhatsThis::add(d-&gt;ck_newHeadings,
 		tr(&quot;Toggles on new, smaller group headings.&quot;));
 
@@ -125,6 +128,7 @@
 
 	OptAppearanceUI *d = (OptAppearanceUI *)w;
 	opt-&gt;clNewHeadings = d-&gt;ck_newHeadings-&gt;isChecked();
+	opt-&gt;clStIndicator = d-&gt;ck_statusIndicator-&gt;isChecked();
 
 	int n;
 	for (n = 0; n &lt; 3; ++n)
@@ -141,6 +145,7 @@
 
 	OptAppearanceUI *d = (OptAppearanceUI *)w;
 	d-&gt;ck_newHeadings-&gt;setChecked( opt-&gt;clNewHeadings );
+	d-&gt;ck_statusIndicator-&gt;setChecked( opt-&gt;clStIndicator );
 
 	int n;
 	for (n = 0; n &lt; 3; ++n)
diff -ru -X exclude psi-clean/src/psiiconset.cpp psi/src/psiiconset.cpp
--- psi-clean/src/psiiconset.cpp	Sun Jan 25 14:52:04 2004
+++ psi/src/psiiconset.cpp	Thu Apr 15 07:05:08 2004
@@ -510,6 +510,19 @@
 	return Icon();
 }
 
+Icon *PsiIconset::indicatorPtr(const XMPP::Jid &amp;jid)
+{
+	return d-&gt;jid2icon(jid, &quot;psi/statInd&quot;);
+}
+
+Icon PsiIconset::indicator(const XMPP::Jid &amp;jid)
+{
+	Icon *icon = indicatorPtr(jid);
+	if ( icon )
+		return *icon;
+	return Icon();
+}
+
 Icon *PsiIconset::statusPtr(const XMPP::Jid &amp;jid, int s)
 {
 	return d-&gt;jid2icon(jid, status2name(s));
diff -ru -X exclude psi-clean/src/psiiconset.h psi/src/psiiconset.h
--- psi-clean/src/psiiconset.h	Sat Nov 22 07:47:10 2003
+++ psi/src/psiiconset.h	Thu Apr 15 07:05:08 2004
@@ -61,9 +61,11 @@
 	// JID-enabled status functions
 	Icon *statusPtr(const XMPP::Jid &amp;, int);
 	Icon *statusPtr(const XMPP::Jid &amp;, const XMPP::Status &amp;);
+	Icon *indicatorPtr(const XMPP::Jid &amp;);
 
 	Icon status(const XMPP::Jid &amp;, int);
 	Icon status(const XMPP::Jid &amp;, const XMPP::Status &amp;);
+	Icon indicator(const XMPP::Jid &amp;);
 
 	// functions to get status icon by transport name
 	Icon *transportStatusPtr(QString name, int);
diff -ru -X exclude psi-clean/src/psi_profiles.cpp psi/src/psi_profiles.cpp
--- psi-clean/src/psi_profiles.cpp	Sun Mar 21 15:47:06 2004
+++ psi/src/psi_profiles.cpp	Thu Apr 15 07:05:08 2004
@@ -423,6 +423,8 @@
 		prefs.font[fPopup] = font.toString();
 	}
 
+	prefs.clStIndicator = TRUE;
+
 	// calculate the small font size
 	const int minimumFontSize = 7;
 	prefs.smallFontSize = qApp-&gt;font().pointSize();
@@ -774,6 +776,7 @@
 		p.appendChild(p_lnf);
 
 		p_lnf.appendChild(textTag(doc, &quot;newHeadings&quot;, prefs.clNewHeadings));
+		p_lnf.appendChild(textTag(doc, &quot;statusIndicator&quot;, prefs.clStIndicator));
 
 		{
 			QDomElement tag = doc.createElement(&quot;colors&quot;);
@@ -1258,6 +1261,7 @@
 			bool found;
 
 			readBoolEntry(p_lnf, &quot;newHeadings&quot;, &amp;prefs.clNewHeadings);
+			readBoolEntry(p_lnf, &quot;statusIndicator&quot;, &amp;prefs.clStIndicator);
 
 			QDomElement tag = findSubTag(p_lnf, &quot;colors&quot;, &amp;found);
 			if(found) {
diff -ruN psi.orig/iconsets/roster/default/icondef.xml psi/iconsets/roster/default/icondef.xml
--- psi.orig/iconsets/roster/default/icondef.xml	2004-04-22 21:49:53.000000000 +0200
+++ psi/iconsets/roster/default/icondef.xml	2004-05-06 20:32:33.000000000 +0200
@@ -62,6 +62,11 @@
 		&lt;object mime='image/png'&gt;perr.png&lt;/object&gt;
 	&lt;/icon&gt;
 
+	&lt;icon&gt;
+		&lt;x xmlns='name'&gt;psi/statInd&lt;/x&gt;
+		&lt;object mime='image/png'&gt;indicator.png&lt;/object&gt;
+	&lt;/icon&gt;
+
 	&lt;!-- Special icons --&gt;
 	&lt;icon&gt;
 		&lt;x xmlns='name'&gt;psi/chat&lt;/x&gt;

--- NEW FILE: psi-translations.pw.patch ---
diff -u src/main.cpp.orig src/main.cpp
--- src/main.cpp.orig	2002-10-30 11:09:34.000000000 +0100
+++ src/main.cpp	2003-03-15 17:59:59.000000000 +0100
@@ -55,7 +55,7 @@
 	}
 
 	QStringList dirs;
-	QString subdir = &quot;&quot;;
+	QString subdir = &quot;/translations&quot;;
 	dirs += &quot;.&quot; + subdir;
 	dirs += g.pathHome + subdir;
 	dirs += g.pathBase + subdir;
@@ -121,7 +121,7 @@
 	langs.set(&quot;en&quot;, &quot;English&quot;);
 
 	QStringList dirs;
-	QString subdir = &quot;&quot;;
+	QString subdir = &quot;/translations&quot;;
 	dirs += &quot;.&quot; + subdir;
 	dirs += g.pathHome + subdir;
 	dirs += g.pathBase + subdir;

--- NEW FILE: psi.pwbuild ---
#!/bin/sh

name=&quot;psi&quot;
version=&quot;0.9.2&quot;
build=&quot;1&quot;

_pwbuilder 0.6.3

_doc -d libpsi/iconset/ICONSET-HOWTO

_source -m e29f90aea7d839f2a70e4a6e77e95a70 -s 1154392 -f

_patch -p 0 translations
_patch no_online_status
_patch no_default_status_text
_patch status_history
_patch status_indicator
_patch offline_status

_have_libmng &amp;&amp; _patch enable-mng

_c_opt --prefix=/usr

_configure

( cd ${src1}/src ; qmake -o Makefile )
_qconf_fix ${src1}/src/Makefile

# If you get a 'double const' error, uncomment these lines:
#
# sed &quot;s}\$(QTDIR)/bin/uic}${src}/uic-wrapper}&quot; ${src1}/src/Makefile &gt; ${tmp}/uicfix
# cat ${tmp}/uicfix &gt; ${src1}/src/Makefile

_patch opt

_make
_install

rm ${pkg}/usr/share/psi/{COPYING,README}
ln -s ${docdir}/COPYING ${pkg}/usr/share/psi
ln -s ${docdir}/README ${pkg}/usr/share/psi

# $Log: psi.pwbuild,v $
# Revision 1.1  2004/07/30 20:34:54  swiergot
# - Initial commit.
# - Version 0.9.2/20040730.
#

--- NEW FILE: psi.pwinfo ---
info=&quot;A Jabber client for X Window.&quot;
desc=&quot;Psi is the premiere Instant Messaging application designed for Microsoft Windows, Apple Mac OS X and GNU/Linux. Built upon an open protocol named Jabber, Psi is a fast and lightweight messaging client that utilises the best in open source technologies.
Psi contains all the features necessary to chat, with no bloated extras that slow your computer down.&quot;

--- NEW FILE: uic-wrapper ---
#!/bin/sh

/usr/lib/qt/bin/uic &quot;$@&quot;
ret=$?

if [ $ret -gt 0 ]; then
	exit $ret
fi

while [ $# -gt 0 ]; do
	if [ &quot;$1&quot; = &quot;-o&quot; ]; then
		of=&quot;$2&quot;
		break;
	fi
	shift
done

sed 's}static const unsigned char const}static const unsigned char}' $of &gt; ${tmp}/uic-wrapper.tmp
cat ${tmp}/uic-wrapper.tmp &gt; $of


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000049.html">[Packware-cvs] pwbuild/xap/psi - New directory
</A></li>
	<LI>Next message: <A HREF="000051.html">[Packware-cvs] pwbuild/ap - New directory
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#50">[ date ]</a>
              <a href="thread.html#50">[ thread ]</a>
              <a href="subject.html#50">[ subject ]</a>
              <a href="author.html#50">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/packware-cvs">More information about the Packware-cvs
mailing list</a><br>
</body></html>
